{% extends "base.html" %}

{% block title %}{% if news_item %}{{ t('admin.edit_news') }}{% else %}{{ t('admin.add_news') }}{% endif %} - SDU
SuperApp{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('admin.news') }}" class="back-link">
        <i class="fas fa-arrow-left"></i> {{ t('admin.back_list') }}
    </a>

    <div class="page-header">
        <h1><i class="fas fa-{% if news_item %}edit{% else %}plus{% endif %}"></i> {% if news_item %}{{
            t('admin.edit_news') }}{% else %}{{ t('admin.add_news') }}{%
            endif %}</h1>
    </div>

    <div class="form-card-page">
        <form
            action="{% if news_item %}{{ url_for('admin.edit_news', news_id=news_item.id) }}{% else %}{{ url_for('admin.add_news') }}{% endif %}"
            method="POST" class="admin-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">{{ t('admin.title') }} *</label>
                <input type="text" id="title" name="title" class="form-input"
                    value="{% if news_item %}{{ news_item.title }}{% endif %}" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="category">{{ t('admin.category') }} *</label>
                    <select id="category" name="category" class="form-select" required>
                        <option value="Announcement" {% if news_item and news_item.category=='Announcement' %}selected{%
                            endif %}>Announcement</option>
                        <option value="Event" {% if news_item and news_item.category=='Event' %}selected{% endif %}>
                            Event</option>
                        <option value="Academic" {% if news_item and news_item.category=='Academic' %}selected{% endif
                            %}>Academic</option>
                        <option value="Sports" {% if news_item and news_item.category=='Sports' %}selected{% endif %}>
                            Sports</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" id="author" name="author" class="form-input"
                        value="{% if news_item %}{{ news_item.author }}{% else %}Admin{% endif %}">
                </div>
            </div>

            <!-- Image Upload -->
            <div class="form-group">
                <label>{{ t('admin.image') }}</label>
                <div class="image-upload-tabs">
                    <div class="upload-tab-buttons">
                        <button type="button" class="tab-btn active" onclick="showTab('upload')">
                            <i class="fas fa-upload"></i> {{ t('admin.upload_pc') }}
                        </button>
                        <button type="button" class="tab-btn" onclick="showTab('url')">
                            <i class="fas fa-link"></i> {{ t('admin.image_url') }}
                        </button>
                    </div>

                    <div id="upload-tab" class="upload-tab-content active">
                        <input type="file" id="image_file" name="image_file" class="form-input"
                            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" onchange="previewImage(this)">
                        <small class="form-hint">{{ t('admin.formats') }} <strong>800x400
                                px</strong></small>
                        <div id="new-image-preview" style="display: none; margin-top: 1rem;">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">{{
                                t('admin.new_image') }}</p>
                            <img id="preview-img" src="" alt="Preview"
                                style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary);">
                        </div>
                    </div>

                    <div id="url-tab" class="upload-tab-content">
                        <input type="url" id="image_url" name="image_url" class="form-input"
                            value="{% if news_item and news_item.image and not news_item.image.startswith('/static') %}{{ news_item.image }}{% endif %}"
                            placeholder="https://example.com/image.jpg" oninput="previewUrlImage(this)">
                        <small class="form-hint">{{ t('admin.enter_link') }}</small>
                        <div id="url-image-preview" style="display: none; margin-top: 1rem;">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">{{
                                t('admin.preview') }}
                            </p>
                            <img id="url-preview-img" src="" alt="Preview"
                                style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary);">
                        </div>
                    </div>
                </div>
            </div>

            {% if news_item and news_item.image %}
            <div class="form-group">
                <label>{{ t('admin.current_image') }}</label>
                <div class="image-preview">
                    <img src="{{ news_item.image }}" alt="{{ news_item.title }}"
                        style="max-width: 300px; max-height: 200px; border-radius: 8px;">
                    <input type="hidden" name="current_image" value="{{ news_item.image }}">
                    <button type="button" class="btn btn-sm btn-danger" style="margin-top: 0.5rem;"
                        onclick="removeImage()">
                        <i class="fas fa-times"></i> {{ t('admin.delete_image') }}
                    </button>
                    <input type="hidden" name="remove_image" id="remove_image" value="no">
                </div>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="content">{{ t('admin.content') }} *</label>
                <textarea id="content" name="content" class="form-input" rows="10" required
                    placeholder="{{ t('admin.content') }}...">{% if news_item %}{{ news_item.content }}{% endif %}</textarea>
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" name="publish" id="publish" {% if not news_item or news_item.is_published
                    %}checked{% endif %}>
                <label for="publish">{{ t('admin.publish') }}</label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> {{ t('admin.save') }}
                </button>
                <a href="{{ url_for('admin.news') }}" class="btn btn-outline btn-lg">{{ t('admin.cancel') }}</a>
                {% if news_item %}
                <button type="button" class="btn btn-danger btn-lg" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> {{ t('admin.delete') }}
                </button>
                {% endif %}
            </div>
        </form>

        {% if news_item %}
        <form id="delete-form" action="{{ url_for('admin.delete_news', news_id=news_item.id) }}" method="POST"
            style="display: none;">
        </form>
        {% endif %}
    </div>
</div>

{% if news_item %}
<script>
    function confirmDelete() {
        if (confirm("{{ t('admin.delete_news_confirm_long') }}")) {
            document.getElementById('delete-form').submit();
        }
    }

    function removeImage() {
        if (confirm("{{ t('admin.delete_image_confirm') }}")) {
            document.getElementById('remove_image').value = 'yes';
            document.querySelector('.image-preview').style.display = 'none';
        }
    }
</script>
{% endif %}

<script>
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.upload-tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Показываем выбранный таб
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }

    function previewImage(input) {
        const preview = document.getElementById('new-image-preview');
        const img = document.getElementById('preview-img');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                img.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }

    let urlPreviewTimeout;
    function previewUrlImage(input) {
        const preview = document.getElementById('url-image-preview');
        const img = document.getElementById('url-preview-img');

        clearTimeout(urlPreviewTimeout);

        if (input.value.trim()) {
            urlPreviewTimeout = setTimeout(() => {
                img.src = input.value;
                img.onload = function () {
                    preview.style.display = 'block';
                };
                img.onerror = function () {
                    preview.style.display = 'none';
                };
            }, 500);
        } else {
            preview.style.display = 'none';
        }
    }
</script>

<style>
    .image-upload-tabs {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .upload-tab-buttons {
        display: flex;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
    }

    .tab-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-secondary);
        transition: all 0.2s;
    }

    .tab-btn:hover {
        background: var(--bg-secondary);
    }

    .tab-btn.active {
        background: var(--bg-primary);
        color: var(--primary);
        font-weight: 500;
    }

    .upload-tab-content {
        display: none;
        padding: 1rem;
    }

    .upload-tab-content.active {
        display: block;
    }

    .upload-tab-content input[type="file"] {
        padding: 0.75rem;
    }
</style>
{% endblock %}